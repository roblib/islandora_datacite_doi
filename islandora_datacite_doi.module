<?php

/**
 * @file
 * Module to supply an api for creating Datacite DOIs.
 */

/**
 * Implements hook_menu().
 */
function islandora_datacite_doi_menu() {
  $items = array();

  $items['admin/islandora/islandora_datacite_doi'] = array(
    'title' => 'Islandora Datacite DOI settings',
    'description' => 'Configure settings for the Islandora Datacite DOI module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_datacite_doi_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );

  return $items;
}

/**
 * Conveinence method to register, mint a doi as well as update the source metadata stream with the DOI.
 * @code
 *  function islandora_datacite_doi_islandora_object_ingested(AbstractObject $object) {
 *    $test = islandora_datacite_doi_mint_doi($object, 'MODS');
 *    if($test < 0){
 *      drupal_set_message(t('Datacite DOI error, check watchdog logs for more information.'),'warning');
 *     }
 *   }
 * @endcode
 * @param string $object
 *   An Islandora AbstractObject
 * @param string $dsid
 *   The dsid used to retrieve metadata
 * @param string $type
 *   The type currently only support DDI but hope to add MODS
 * @return int
 *   0 for success
 */
function islandora_datacite_doi_mint_doi($object, $dsid) {
  $return_value = 0;
  switch ($dsid) {
    case "DDI":
      $xsl_file_name = 'ddi_3_2-datacite_3_1.xsl';
      break;

    case "MODS":
      $xsl_file_name = 'MODS-to-Datacite_3_1.xsl';
      break;

    default :
      $xsl_file_name = NULL;
  }
  if ($xsl_file_name) {
    try {
      islandora_datacite_doi_mint($object, $dsid, $xsl_file_name);
      } catch (Exception $e) {
      watchdog('islandora_datacite_doi', 'DOI Error for @object - @dsid, @error', array(
        '@object' => $object->id, '@dsid' => $dsid, '@error' => $e->getMessage()), WATCHDOG_ERROR);
      $return_value = -2;
      }
  }
  else {
    watchdog('islandora_datacite_doi', 'DOI Error for @object - @dsid, Unsupported type.', array(
      '@object' => $object->id, '@dsid' => $dsid), WATCHDOG_ERROR);
    $return_value = -1;
  }

  return $return_value;
}

/**
 * Registers and mints a datacite DOI
 * 
 * @param string $object
 *   An islandora AbstractObject
 * @param type $dsid
 *   The dsid that holds the DDI content
 * 
 * @throws Exception
 *   if registration, minting or updating the xml fails
 */
function islandora_datacite_doi_mint($object, $dsid = "DDI", $xslt_path) {
  module_load_include('inc', 'islandora_datacite_doi', 'includes/datacite_doi.inc');
  $datacite = new DataciteDoi(variable_get('islandora_datacite_doi_prefix'), variable_get('islandora_datacite_doi_site'), $object->id, variable_get('islandora_datacite_doi_username'), variable_get('islandora_datacite_doi_password'));
  islandora_datacite_doi_register_doi($object, $dsid, $datacite, $xslt_path);
  islandora_datacite_doi_send_doi($datacite);
  $new_metaData = $datacite->updateMetaData($datacite->getDoi(), $object[$dsid]->content, $dsid);
  if ($new_metaData === -1) {
    throw new Exception("Failed to add DOI to DDI xml");
  }
  // We've updated the doi in the ddi so send it back to Fedora.
  $object[$dsid]->setContentFromString($new_metaData);
}

/**
 * Send the url and doi to Datacite.
 * 
 * @param string pid
 * @param DataciteDoi $datacite
 * @throws Exception
 */
function islandora_datacite_doi_send_doi($datacite) {
  $url = url("islandora/object/$datacite->pid", array(
    'language' => (object) array('language' => FALSE),
    'absolute' => TRUE,
    'https' => variable_get('islandora_datacite_doi_use_ssl', FALSE),
  ));
  $response = $datacite->sendDoiToDatacite($url);
  if (empty($response->code) || $response->code != '201') {
    throw new Exception("Failed to mint DOI for " . $datacite->getDOI() . ", Error sending DOI to datacite, $response->status_message");
  }
}

/**
 * Register datacite xml as metadata.
 *
 * We need to register a DOI with metadata before we can mint it.
 *
 * @param object $object
 *   An Islandora object
 * @param string $dsid
 *   The dsid containing the metadata to crosswalk.  
 * @param object $datacite
 *   A DataciteDoi object
 *
 * @throws Exception
 *   if there are errors transforming xml or communicating with Datacite
 */
function islandora_datacite_doi_register_doi($object, $dsid, $datacite, $xslt_path) {
  $doi = $datacite->getDoi();
  $datacite_xml = $datacite->transformMetadataToDacite($object[$dsid]->content, $doi, $xslt_path);
  if (empty($datacite_xml)) {
    throw new Exception('Error transforming DDI to Datacite xml for object ' . $object->id);
  }
  $response = $datacite->sendXmlToDatacite($datacite_xml);
  if (empty($response->code) || $response->code != '201') {
    throw new Exception("Failed to register datacite xml with $doi error connecting to datacite, $response->status_message");
  }
}

/**
 * Make a DOI inactive on Datacite
 * @param string $pid
 *   An islandora object pid
 */
function islandora_datacite_doi_delete($pid) {
  $datacite = new DataciteDoi(variable_get('islandora_datacite_doi_prefix'), variable_get('islandora_datacite_doi_site'), $object->id, variable_get('islandora_datacite_doi_username'), variable_get('islandora_datacite_doi_password'));
  $datacite->deleteDataciteDoi();
}
